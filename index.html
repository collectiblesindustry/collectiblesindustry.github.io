<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Midwest Card Shows</title>
  <meta name="description" content="Midwest card shows — list + calendar with map previews, visible event titles, and month navigation." />
  <style>
    :root { --bg:#0b0d12; --muted:#9aa4b2; --text:#eef2ff; --line:#22283a; --accent:#7aa2ff; }
    * { box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, #1a2450 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 10%, #3a1a4f 0%, transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{ max-width:1180px; margin:0 auto; padding:26px 18px 10px; }
    h1{ margin:0 0 6px; font-size:26px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.45; }

    .wrap{ max-width:1180px; margin:0 auto; padding:12px 18px 40px; }
    .tabs{ display:flex; gap:10px; margin:14px 0 12px; }
    .tab{
      border:1px solid var(--line); background:rgba(255,255,255,0.02); color:var(--text);
      padding:9px 12px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .tab.active{ border-color:rgba(122,162,255,0.65); box-shadow:0 0 0 3px rgba(122,162,255,0.08) inset; }

    .controls{
      display:grid; grid-template-columns: 1.2fr .7fr .7fr .7fr .7fr;
      gap:10px; margin:10px 0 16px;
    }
    input, select, button{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:#6f7b8a; }
    button{ cursor:pointer; }
    button:hover{ border-color:rgba(122,162,255,0.5); }

    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px; border:1px solid var(--line);
           background:rgba(255,255,255,0.02); color:var(--muted); font-size:12px; }

    /* List */
    .listWrap{ display:none; }
    .listWrap.active{ display:block; }
    .listGrid{ display:grid; grid-template-columns:1fr; gap:12px; }

    .eventCard{
      background:rgba(18,22,34,0.85);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 8px 30px rgba(0,0,0,0.35);
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      min-height:190px;
    }
    .eventInfo{ padding:14px; }
    .titleRow{ display:flex; gap:10px; justify-content:space-between; align-items:flex-start; }
    .title{ margin:0 0 6px; font-size:15px; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ font-size:13px; }
    .row{ margin:6px 0 0; }

    .tag{ font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:#c8d1ff; white-space:nowrap; }
    .tag.sports{ border-color:rgba(122,162,255,0.45); }
    .tag.tcg{ border-color:rgba(255,122,200,0.40); color:#ffd1ee; }
    .tag.collectibles{ border-color:rgba(120,255,200,0.35); color:#d8ffef; }

    .badge{ font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); white-space:nowrap; }
    .badge.fresh{ border-color:rgba(120,255,200,0.45); color:#d8ffef; }
    .badge.aging{ border-color:rgba(255,220,120,0.45); color:#fff0c7; }
    .badge.stale{ border-color:rgba(255,120,120,0.45); color:#ffd0d0; }

    .rightBadges{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    a.action{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:8px 10px; font-size:13px;
      background:rgba(255,255,255,0.02);
    }
    a.action:hover{ border-color:rgba(122,162,255,0.5); }

    .mapPane{ border-left:1px solid var(--line); background:rgba(255,255,255,0.01); position:relative; min-height:190px; }
    .mapPane img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mapOverlay{
      position:absolute; left:10px; top:10px;
      background:rgba(18,22,34,0.85);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(6px);
    }
    .mapMissing{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      padding:12px;
      text-align:center;
    }

    /* Calendar */
    .calWrap{ display:none; }
    .calWrap.active{ display:block; }
    .calHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 12px; }
    .calTitle{ font-size:15px; }
    .calNav{ display:flex; gap:8px; }

    .calGrid{
      display:grid; grid-template-columns: repeat(7, 1fr);
      gap:8px; border:1px solid var(--line);
      border-radius:18px; padding:10px;
      background:rgba(18,22,34,0.55);
    }
    .dow{ color:var(--muted); font-size:11px; padding:4px 6px; text-transform:uppercase; letter-spacing:.6px; }
    .day{
      min-height:110px;
      border:1px solid rgba(34,40,58,0.7);
      border-radius:14px;
      padding:8px;
      cursor:pointer;
      background:rgba(255,255,255,0.01);
      overflow:hidden;
    }
    .day:hover{ border-color:rgba(122,162,255,0.35); }
    .day.muted{ opacity:.45; }
    .dayNum{ font-size:12px; color:var(--muted); }

    /* NEW: visible event rows in calendar cells */
    .dayEvents { margin-top: 6px; display: grid; gap: 4px; }
    .dayEvent {
      border: 1px solid rgba(34,40,58,0.9);
      border-radius: 10px;
      padding: 4px 6px;
      background: rgba(18,22,34,0.45);
      font-size: 11px;
      line-height: 1.2;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .dayEvent .time { color: var(--muted); margin-right: 6px; }
    .dayEvent.sports { border-color: rgba(122,162,255,0.45); }
    .dayEvent.tcg { border-color: rgba(255,122,200,0.40); }
    .dayEvent.collectibles { border-color: rgba(120,255,200,0.35); }
    .moreLink {
      font-size: 11px;
      color: var(--accent);
      margin-top: 2px;
      width: fit-content;
    }
    .moreLink:hover { text-decoration: underline; }

    .drawer{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:rgba(18,22,34,0.65);
    }
    .drawerTitle{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
    .drawerTitle b{ font-size:14px; }
    .mini{ font-size:12px; color:var(--muted); }
    .drawerList{ margin-top:10px; display:grid; gap:10px; }

    .empty{ padding:18px; border:1px dashed var(--line); border-radius:18px; color:var(--muted); }

    @media (max-width: 980px){
      .controls{ grid-template-columns:1fr 1fr; }
      .eventCard{ grid-template-columns:1fr; }
      .mapPane{ border-left:0; border-top:1px solid var(--line); min-height:220px; }
    }
    @media (max-width: 620px){
      .controls{ grid-template-columns:1fr; }
      .day{ min-height:96px; }
    }
  </style>
</head>
<body>
<header>
  <h1>Midwest Card Shows</h1>
  <div class="sub">All shows live in <code>events.json</code>. Calendar view displays event titles directly on each day.</div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" id="tabList">List</button>
    <button class="tab" id="tabCal">Calendar</button>
  </div>

  <div class="controls">
    <input id="q" placeholder="Search (venue, city, address, title…)" />
    <select id="state"><option value="">All states</option></select>
    <select id="city"><option value="">All cities</option></select>
    <select id="category">
      <option value="">All categories</option>
      <option value="sports">Sports</option>
      <option value="tcg">TCG</option>
      <option value="collectibles">Collectibles</option>
    </select>
    <select id="sort">
      <option value="asc">Sort: soonest</option>
      <option value="desc">Sort: latest</option>
    </select>
  </div>

  <div class="meta">
    <div class="pill" id="countPill">0 events</div>
    <div class="pill">Tip: add <code>?v=8</code> to the URL to bust cache after updates</div>
  </div>

  <div class="listWrap active" id="listWrap"><div id="list" class="listGrid"></div></div>

  <div class="calWrap" id="calWrap">
    <div class="calHeader">
      <div class="calTitle" id="calTitle">Month</div>
      <div class="calNav">
        <button id="prevMonth">◀</button>
        <button id="today">Today</button>
        <button id="nextMonth">▶</button>
      </div>
    </div>
    <div class="calGrid" id="calGrid"></div>

    <div class="drawer">
      <div class="drawerTitle">
        <b id="drawerDate">Select a day</b>
        <span class="mini" id="drawerMeta"></span>
      </div>
      <div class="drawerList" id="drawerList">
        <div class="mini">Click a day in the calendar to see all events for that day.</div>
      </div>
    </div>
  </div>
</div>

<script>
let EVENTS = [];

// ---------- DOM ----------
const $q = document.getElementById('q');
const $state = document.getElementById('state');
const $city = document.getElementById('city');
const $category = document.getElementById('category');
const $sort = document.getElementById('sort');
const $countPill = document.getElementById('countPill');

const $tabList = document.getElementById('tabList');
const $tabCal = document.getElementById('tabCal');
const $listWrap = document.getElementById('listWrap');
const $calWrap = document.getElementById('calWrap');

const $list = document.getElementById('list');

const $calTitle = document.getElementById('calTitle');
const $calGrid = document.getElementById('calGrid');
const $prevMonth = document.getElementById('prevMonth');
const $nextMonth = document.getElementById('nextMonth');
const $todayBtn = document.getElementById('today');

const $drawerDate = document.getElementById('drawerDate');
const $drawerMeta = document.getElementById('drawerMeta');
const $drawerList = document.getElementById('drawerList');

// ---------- helpers ----------
function uniq(arr){ return [...new Set(arr)].sort((a,b)=>a.localeCompare(b)); }

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function formatWhen(ev){
  const start = ev.start ? new Date(ev.start) : null;
  const end = ev.end ? new Date(ev.end) : null;
  if(!start) return "TBD";
  const dateFmt = new Intl.DateTimeFormat('en-US',{ weekday:'short', year:'numeric', month:'short', day:'2-digit' });
  const timeFmt = new Intl.DateTimeFormat('en-US',{ hour:'numeric', minute:'2-digit' });

  const d = dateFmt.format(start);
  const t1 = timeFmt.format(start);
  if(!end) return `${d} • ${t1} – TBD`;
  const sameDay = start.toDateString() === end.toDateString();
  if(sameDay) return `${d} • ${t1} – ${timeFmt.format(end)}`;
  return `${dateFmt.format(start)} ${timeFmt.format(start)} → ${dateFmt.format(end)} ${timeFmt.format(end)}`;
}

function formatTimeOnly(iso){
  if(!iso) return "";
  return new Intl.DateTimeFormat('en-US',{ hour:'numeric', minute:'2-digit' }).format(new Date(iso));
}

function daysSince(dateStr){
  if(!dateStr) return Infinity;
  const d = new Date(dateStr + "T00:00:00");
  const now = new Date();
  return Math.floor((now - d) / (1000*60*60*24));
}
function freshnessBadge(lastVerified){
  const d = daysSince(lastVerified);
  if(!isFinite(d)) return { cls:"stale", label:"Unverified" };
  if(d <= 30) return { cls:"fresh", label:`Fresh (${d}d)` };
  if(d <= 90) return { cls:"aging", label:`Aging (${d}d)` };
  return { cls:"stale", label:`Stale (${d}d)` };
}

function osmStaticMapUrl(lat, lon){
  const center = `${lat},${lon}`;
  return `https://staticmap.openstreetmap.de/staticmap.php?center=${center}&zoom=13&size=600x360&markers=${center},red-pushpin`;
}

function mapsLink(ev){
  const q = encodeURIComponent(`${ev.venue} ${ev.address}`);
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}

function eventKeyLocalDayFromISO(iso){
  if(!iso) return null;
  const d = new Date(iso);
  const pad = (n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function eventKeyLocalDay(ev){
  return eventKeyLocalDayFromISO(ev.start);
}

// ---------- filters ----------
function filteredEvents(){
  const q = ($q.value||"").trim().toLowerCase();
  const state = $state.value;
  const city = $city.value;
  const cat = $category.value;
  const sort = $sort.value;

  let items = EVENTS.slice();

  if(q){
    items = items.filter(ev =>
      (ev.title||"").toLowerCase().includes(q) ||
      (ev.venue||"").toLowerCase().includes(q) ||
      (ev.address||"").toLowerCase().includes(q) ||
      (ev.city||"").toLowerCase().includes(q) ||
      (ev.state||"").toLowerCase().includes(q) ||
      (ev.category||"").toLowerCase().includes(q) ||
      (ev.notes||"").toLowerCase().includes(q)
    );
  }
  if(state) items = items.filter(ev => ev.state === state);
  if(city) items = items.filter(ev => ev.city === city);
  if(cat) items = items.filter(ev => ev.category === cat);

  items.sort((a,b)=>{
    const da = a.start ? new Date(a.start).getTime() : Infinity;
    const db = b.start ? new Date(b.start).getTime() : Infinity;
    return sort === "asc" ? da - db : db - da;
  });

  return items;
}

function rebuildDropdowns(){
  const states = uniq(EVENTS.map(e=>e.state).filter(Boolean));
  const prevState = $state.value;
  $state.innerHTML = `<option value="">All states</option>` + states.map(s=>`<option value="${s}">${s}</option>`).join("");
  $state.value = states.includes(prevState) ? prevState : "";

  const pool = $state.value ? EVENTS.filter(e=>e.state === $state.value) : EVENTS;
  const cities = uniq(pool.map(e=>e.city).filter(Boolean));
  const prevCity = $city.value;
  $city.innerHTML = `<option value="">All cities</option>` + cities.map(c=>`<option value="${c}">${c}</option>`).join("");
  $city.value = cities.includes(prevCity) ? prevCity : "";
}

// ---------- view toggle ----------
function setView(view){
  if(view === "list"){
    $tabList.classList.add("active");
    $tabCal.classList.remove("active");
    $listWrap.classList.add("active");
    $calWrap.classList.remove("active");
  } else {
    $tabCal.classList.add("active");
    $tabList.classList.remove("active");
    $calWrap.classList.add("active");
    $listWrap.classList.remove("active");
    buildCalendar();
  }
}
$tabList.addEventListener('click', ()=>setView("list"));
$tabCal.addEventListener('click', ()=>setView("cal"));

// ---------- render list ----------
function renderList(){
  const items = filteredEvents();
  $countPill.textContent = `${items.length} event${items.length===1?"":"s"}`;
  $list.innerHTML = "";

  if(!items.length){
    const d = document.createElement('div');
    d.className = "empty";
    d.textContent = "No events match your filters.";
    $list.appendChild(d);
    return;
  }

  for(const ev of items){
    const card = document.createElement('div');
    card.className = "eventCard";

    const info = document.createElement('div');
    info.className = "eventInfo";

    const fb = freshnessBadge(ev.last_verified);

    info.innerHTML = `
      <div class="titleRow">
        <div>
          <h3 class="title">${escapeHtml(ev.title)}</h3>
          <div class="row"><span class="k">When:</span> <span class="v">${escapeHtml(formatWhen(ev))}</span></div>
          <div class="row"><span class="k">Where:</span> <span class="v">${escapeHtml(ev.venue)} — ${escapeHtml(ev.address)}</span></div>
          <div class="row"><span class="k">Area:</span> <span class="v">${escapeHtml(ev.city)}, ${escapeHtml(ev.state)}</span></div>
          <div class="row"><span class="k">Last verified:</span> <span class="v">${escapeHtml(ev.last_verified || "Unknown")}</span></div>
          ${ev.notes ? `<div class="row"><span class="k">Notes:</span> <span class="v">${escapeHtml(ev.notes)}</span></div>` : ""}
          <div class="actions">
            <a class="action" href="${mapsLink(ev)}" target="_blank" rel="noopener noreferrer">Map</a>
            ${ev.url ? `<a class="action" href="${ev.url}" target="_blank" rel="noopener noreferrer">Organizer</a>` : ""}
          </div>
        </div>
        <div class="rightBadges">
          <span class="tag ${ev.category || ""}">${escapeHtml((ev.category || "show").toUpperCase())}</span>
          <span class="badge ${fb.cls}">${escapeHtml(fb.label)}</span>
        </div>
      </div>
    `;

    const mapPane = document.createElement('div');
    mapPane.className = "mapPane";

    if(typeof ev.lat === "number" && typeof ev.lon === "number"){
      const img = document.createElement('img');
      img.loading = "lazy";
      img.alt = `Map preview for ${ev.venue}`;
      img.src = osmStaticMapUrl(ev.lat, ev.lon);

      const overlay = document.createElement('div');
      overlay.className = "mapOverlay";
      overlay.textContent = "Map preview";

      mapPane.appendChild(img);
      mapPane.appendChild(overlay);
    } else {
      mapPane.innerHTML = `<div class="mapMissing">No map image yet (add <code>lat</code>/<code>lon</code> in <code>events.json</code>).<br/>Use the “Map” button.</div>`;
    }

    card.appendChild(info);
    card.appendChild(mapPane);
    $list.appendChild(card);
  }
}

// ---------- calendar ----------
let calCursor = new Date();
calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
let selectedDayKey = null;

function monthLabel(d){
  return new Intl.DateTimeFormat('en-US',{ month:'long', year:'numeric' }).format(d);
}

function buildCalendar(){
  const items = filteredEvents();

  const byDay = new Map();
  for(const ev of items){
    const k = eventKeyLocalDay(ev);
    if(!k) continue;
    if(!byDay.has(k)) byDay.set(k, []);
    byDay.get(k).push(ev);
  }

  $calTitle.textContent = monthLabel(calCursor);
  $calGrid.innerHTML = "";

  const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  for(const d of dows){
    const el = document.createElement('div');
    el.className = "dow";
    el.textContent = d;
    $calGrid.appendChild(el);
  }

  const first = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
  const startDow = first.getDay();
  const startDate = new Date(first);
  startDate.setDate(first.getDate() - startDow);

  for(let i=0;i<42;i++){
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);
    const inMonth = d.getMonth() === calCursor.getMonth();

    const pad = (n)=>String(n).padStart(2,'0');
    const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    const cell = document.createElement('div');
    cell.className = "day" + (inMonth ? "" : " muted");

    const num = document.createElement('div');
    num.className = "dayNum";
    num.textContent = d.getDate();

    const evs = byDay.get(key) || [];

    cell.appendChild(num);

    // NEW: show events directly on calendar day cells
    if (evs.length) {
      const wrap = document.createElement('div');
      wrap.className = "dayEvents";

      const sorted = evs.slice().sort((a,b)=>new Date(a.start) - new Date(b.start));
      const MAX_SHOW = 2;

      for (const ev of sorted.slice(0, MAX_SHOW)) {
        const line = document.createElement('div');
        line.className = `dayEvent ${ev.category || ""}`;
        const t = formatTimeOnly(ev.start);

        line.innerHTML = `<span class="time">${escapeHtml(t)}</span>${escapeHtml(ev.title)}`;
        line.title = `${ev.title} | ${t} | ${ev.city}, ${ev.state}`;

        wrap.appendChild(line);
      }

      if (sorted.length > MAX_SHOW) {
        const more = document.createElement('div');
        more.className = "moreLink";
        more.textContent = `+${sorted.length - MAX_SHOW} more`;
        more.addEventListener('click', (e) => {
          e.stopPropagation();
          selectDay(key, evs);
        });
        wrap.appendChild(more);
      }

      cell.appendChild(wrap);
    }

    cell.addEventListener('click', ()=>selectDay(key, evs));
    $calGrid.appendChild(cell);
  }

  if(!selectedDayKey){
    const now = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const todayKey = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    const monthPrefix = `${calCursor.getFullYear()}-${pad(calCursor.getMonth()+1)}`;

    if(todayKey.startsWith(monthPrefix)) selectDay(todayKey, byDay.get(todayKey) || []);
    else {
      const firstKeyWithEvents = [...byDay.keys()].find(k=>k.startsWith(monthPrefix));
      if(firstKeyWithEvents) selectDay(firstKeyWithEvents, byDay.get(firstKeyWithEvents) || []);
      else selectDay(null, []);
    }
  } else {
    selectDay(selectedDayKey, byDay.get(selectedDayKey) || []);
  }
}

function selectDay(key, evs){
  selectedDayKey = key;

  if(!key){
    $drawerDate.textContent = "Select a day";
    $drawerMeta.textContent = "";
    $drawerList.innerHTML = `<div class="mini">No day selected.</div>`;
    return;
  }

  const d = new Date(key + "T00:00:00");
  const label = new Intl.DateTimeFormat('en-US',{ weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(d);
  $drawerDate.textContent = label;
  $drawerMeta.textContent = `${evs.length} event${evs.length===1?"":"s"}`;

  $drawerList.innerHTML = "";
  if(!evs.length){
    $drawerList.innerHTML = `<div class="mini">No events on this day (with current filters).</div>`;
    return;
  }

  evs = evs.slice().sort((a,b)=>new Date(a.start).getTime() - new Date(b.start).getTime());
  for(const ev of evs){
    const fb = freshnessBadge(ev.last_verified);
    const box = document.createElement('div');
    box.style.border = "1px solid var(--line)";
    box.style.borderRadius = "14px";
    box.style.padding = "10px";
    box.style.background = "rgba(18,22,34,0.35)";

    box.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-size:14px; margin-bottom:6px;">${escapeHtml(ev.title)}</div>
          <div class="mini">${escapeHtml(formatWhen(ev))} • ${escapeHtml(ev.city)}, ${escapeHtml(ev.state)}</div>
          <div class="mini">${escapeHtml(ev.venue)}</div>
          <div class="mini">Last verified: ${escapeHtml(ev.last_verified || "Unknown")}</div>
        </div>
        <div class="rightBadges">
          <span class="tag ${ev.category||""}">${escapeHtml((ev.category||"show").toUpperCase())}</span>
          <span class="badge ${fb.cls}">${escapeHtml(fb.label)}</span>
        </div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <a class="action" href="${mapsLink(ev)}" target="_blank" rel="noopener noreferrer">Map</a>
        ${ev.url ? `<a class="action" href="${ev.url}" target="_blank" rel="noopener noreferrer">Organizer</a>` : ""}
      </div>
    `;
    $drawerList.appendChild(box);
  }
}

$prevMonth.addEventListener('click', ()=>{
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
  selectedDayKey = null;
  buildCalendar();
});
$nextMonth.addEventListener('click', ()=>{
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
  selectedDayKey = null;
  buildCalendar();
});
$todayBtn.addEventListener('click', ()=>{
  const now = new Date();
  calCursor = new Date(now.getFullYear(), now.getMonth(), 1);
  selectedDayKey = null;
  buildCalendar();
});

// ---------- wire inputs ----------
function rerenderAll(){
  rebuildDropdowns();
  renderList();
  if($calWrap.classList.contains("active")) buildCalendar();
}
$q.addEventListener('input', rerenderAll);
$state.addEventListener('change', rerenderAll);
$city.addEventListener('change', rerenderAll);
$category.addEventListener('change', rerenderAll);
$sort.addEventListener('change', rerenderAll);

// When state changes, reset city if it no longer exists in state pool
$state.addEventListener('change', ()=>{ $city.value = ""; rerenderAll(); });

// ---------- load data ----------
async function loadEvents(){
  const res = await fetch("./events.json", { cache: "no-store" });
  const data = await res.json();
  EVENTS = (data.events || []).filter(e => e && e.title && e.start);
  rebuildDropdowns();
  renderList();
}
loadEvents().catch(err=>{
  console.error(err);
  $list.innerHTML = `<div class="empty">Could not load <code>events.json</code>. Make sure it exists in the repo root.</div>`;
});
</script>
</body>
</html>
